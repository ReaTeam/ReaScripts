-- @description Move closest crossfade to mouse cursor
-- @author amagalma
-- @version 1.0
-- @link https://forum.cockos.com/showthread.php?t=253026
-- @screenshot https://i.ibb.co/wL5Bj92/move-xfade.gif
-- @donation https://www.paypal.me/amagalma
-- @about
--   # Moves the closest cross-fade to the mouse position
--
--   - Only one undo point is created after key shortcut is released
--   - Requires JS_ReaScriptAPI


if not reaper.APIExists( "\74\83\95\86\75\101\121\115\95\71\101\116\83\116\97\116\101" ) then reaper.MB( "\74\83\95\82\101\97\83\99\114\105\112\116\65\80\73\32\105\115\32\114\101\113\117\105\114\101\100\32\102\111\114\32\116\104\105\115\32\115\99\114\105\112\116\33\32\80\108\101\97\115\101\44\32\105\110\115\116\97\108\108\32\105\116\33", "\77\105\115\115\105\110\103\32\65\80\73\33", 0 ) return reaper.defer(function() end ) end local U8w, lfZ = reaper.GetMousePosition() local qoY9 = {} qoY9.fCOW = reaper.GetItemFromPoint( U8w, lfZ, true ) if not qoY9.fCOW then return reaper.defer(function() end ) end local qu_H = reaper.GetMediaItemInfo_Value( qoY9.fCOW, "\68\95\70\65\68\69\73\78\76\69\78\95\65\85\84\79" ) local Zg = reaper.GetMediaItemInfo_Value( qoY9.fCOW, "\68\95\70\65\68\69\79\85\84\76\69\78\95\65\85\84\79" ) local q96t = qu_H ~= 0  local XYuK = Zg ~= 0 if not q96t and not XYuK then return reaper.defer(function() end ) end local ahS0 = reaper.JS_Window_FindChildByID( reaper.GetMainHwnd(), 1000 ) local tnt = reaper.JS_Window_ScreenToClient( ahS0, 0, 0 ) local function bLV( U8w ) local DsA, GsWo, DsA, WCc = reaper.JS_Window_GetClientRect( ahS0 ) local R_ = reaper.GetSet_ArrangeView2( 0, false, GsWo, WCc ) local oi = reaper.GetHZoomLevel() return R_ + (U8w + tnt) / oi end local SKaM = bLV( U8w ) local BO = reaper.GetMediaItemInfo_Value( qoY9.fCOW, "\73\80\95\73\84\69\77\78\85\77\66\69\82" )  qoY9.lBl = reaper.GetMediaItemInfo_Value( qoY9.fCOW, "\68\95\80\79\83\73\84\73\79\78" ) qoY9.Oe5o = reaper.GetMediaItemInfo_Value( qoY9.fCOW, "\68\95\76\69\78\71\84\72" ) qoY9.XgV = qoY9.lBl + qoY9.Oe5o local GJ7 = reaper.GetMediaItemTrack( qoY9.fCOW ) local abs = math.abs local function jDu_( jT, jX ) return abs( jT - jX ) <= 0.000001 end local Om = reaper.JS_VKeys_GetState( -1 ) local npb = {} local IFq5 = 0 for hG = 0x01, 0xFF do if Om:byte(hG) ~= 0 then IFq5 = IFq5 + 1 npb[IFq5] = hG end end if IFq5 == 0 then return end local AIbE = {} local EAdD, OB local S3v, dopu = {} local function eRC7() AIbE, qoY9 = qoY9, AIbE qoY9.fCOW = EAdD qoY9.lBl = reaper.GetMediaItemInfo_Value( qoY9.fCOW, "\68\95\80\79\83\73\84\73\79\78" ) qoY9.Oe5o = reaper.GetMediaItemInfo_Value( qoY9.fCOW, "\68\95\76\69\78\71\84\72" ) qoY9.XgV = qoY9.lBl + qoY9.Oe5o qu_H, Zg = Zg, qu_H end if q96t and XYuK then EAdD = reaper.GetTrackMediaItem( GJ7, BO-1 ) local R6, E84E if EAdD then if jDu_( reaper.GetMediaItemInfo_Value( EAdD, "\68\95\70\65\68\69\79\85\84\76\69\78\95\65\85\84\79" ), qu_H) then R6 = true end end OB = reaper.GetTrackMediaItem( GJ7, BO+1 ) if OB then if jDu_( reaper.GetMediaItemInfo_Value( OB, "\68\95\70\65\68\69\73\78\76\69\78\95\65\85\84\79" ), Zg) then E84E = true end end if not R6 and not E84E then return reaper.defer(function() end ) end if R6 and E84E then if SKaM - qoY9.lBl < qoY9.XgV - SKaM then eRC7() else AIbE.fCOW = OB end elseif R6 then eRC7() elseif E84E then AIbE.fCOW = OB end elseif q96t then EAdD = reaper.GetTrackMediaItem( GJ7, BO-1 ) if EAdD then if jDu_( reaper.GetMediaItemInfo_Value( EAdD, "\68\95\70\65\68\69\79\85\84\76\69\78\95\65\85\84\79" ), qu_H) then eRC7() end end elseif XYuK then OB = reaper.GetTrackMediaItem( GJ7, BO+1 ) if OB then if jDu_( reaper.GetMediaItemInfo_Value( OB, "\68\95\70\65\68\69\73\78\76\69\78\95\65\85\84\79" ), Zg) then AIbE.fCOW = OB end end end for q5T = 1, IFq5 do reaper.JS_VKeys_Intercept( npb[q5T], 1 ) end local c6M = 0 local E5Y = -1 local function Ru() U8w = reaper.GetMousePosition() SKaM = bLV( U8w ) if SKaM ~= -1 and SKaM ~= E5Y then reaper.PreventUIRefresh( 1 ) E5Y = SKaM qoY9.Oe5o = qoY9.Oe5o + SKaM + Zg/2 - qoY9.XgV qoY9.XgV = qoY9.lBl + qoY9.Oe5o reaper.SetMediaItemInfo_Value( qoY9.fCOW, "\68\95\76\69\78\71\84\72", qoY9.Oe5o ) AIbE.lBl = AIbE.lBl or reaper.GetMediaItemInfo_Value( AIbE.fCOW, "\68\95\80\79\83\73\84\73\79\78" ) AIbE.Oe5o = AIbE.Oe5o or reaper.GetMediaItemInfo_Value(AIbE.fCOW, "\68\95\76\69\78\71\84\72" ) if not dopu then dopu = reaper.CountTakes( AIbE.fCOW ) for V15q = 0, dopu-1 do local WT = reaper.GetTake( AIbE.fCOW, V15q ) S3v[V15q+1] = {WT, reaper.GetMediaItemTakeInfo_Value( WT, "\68\95\83\84\65\82\84\79\70\70\83" )} end end local GI = SKaM - Zg/2 - AIbE.lBl AIbE.lBl = AIbE.lBl + GI reaper.SetMediaItemInfo_Value( AIbE.fCOW, "\68\95\80\79\83\73\84\73\79\78", AIbE.lBl ) AIbE.Oe5o = AIbE.Oe5o - GI reaper.SetMediaItemInfo_Value( AIbE.fCOW, "\68\95\76\69\78\71\84\72", AIbE.Oe5o ) for q5T = 1, dopu do S3v[q5T][2] = S3v[q5T][2] + GI reaper.SetMediaItemTakeInfo_Value( S3v[q5T][1], "\68\95\83\84\65\82\84\79\70\70\83", S3v[q5T][2] ) for tbfk = 0, reaper.GetTakeNumStretchMarkers( S3v[q5T][1] )-1 do local DsA, lBl, WSqK = reaper.GetTakeStretchMarker( S3v[q5T][1], tbfk ) reaper.SetTakeStretchMarker( S3v[q5T][1], tbfk, lBl - GI, WSqK ) end end reaper.PreventUIRefresh( -1 ) end Om = reaper.JS_VKeys_GetUp( -1 ) for q5T = 1, IFq5 do if Om:byte(npb[q5T]) ~= 0 then c6M = c6M + 1 end end if c6M == IFq5 then for q5T = 1, IFq5 do reaper.JS_VKeys_Intercept( npb[q5T], -1 ) end return reaper.Undo_OnStateChange( "\77\111\118\101\32\99\108\111\115\101\115\116\32\120\102\97\100\101\32\116\111\32\109\111\117\115\101\32\99\117\114\115\111\114" ) end reaper.defer(Ru) end Ru()
