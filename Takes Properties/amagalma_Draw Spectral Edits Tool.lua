-- @description Draw Spectral Edits Tool
-- @author amagalma
-- @version 1.01
-- @changelog - correctly restore "Pass through to item drag context" for Media item bottom half left drag mouse context
-- @link https://forum.cockos.com/showthread.php?t=257188
-- @screenshot https://www.youtube.com/watch?v=cFXMku0jtqM
-- @donation https://www.paypal.me/amagalma
-- @about
--   Draw Spectral Edits Tool
--
--   What it is: A tool for easy drawing spectral edits directly on items.
--
--   Supports: a) items with more than one takes, b) multi-channel items, c) display modes with “freq log” different than zero (thanks Justin for the help!).
--
--   Use: Just run the script and draw edits as needed (drawn spectral edits will have the default settings*). When finished, run the script again to disable drawing mode. A tooltip is shown near the mouse cursor to remind you that you are in drawing mode.
--
--   * For drawing with settings saved in presets and for maximum speed, functionality and user experience, it is recommended to use the “Draw Spectral Edits Tool – Preset System” companion script, which is offered separately with a small fee.
--
--   Requirements: JS_ReaScriptAPI, SWS Extension


local dp = reaper.get_ini_file() local ir, jzB = reaper.BR_Win32_GetPrivateProfileString("\114\101\97\112\101\114", "\115\112\101\99\103\114\97\109\95\112\114\101\115\101\116\48", "", dp ) if jzB == "" then return end  local tq = tonumber( jzB:match("\91\37\100\37\46\93\43\32\91\37\100\37\46\93\43\32\91\37\100\37\46\93\43\32\40\91\37\100\37\46\93\43\41") ) local XNQ7 = .1 + tq * tq local Nw = {105, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 202, 203, 204, 417, 418, 419, 420, 421, 429, 430, 431, 433, 434, 450, 453, 460, 461, 462, 463, 464, 465, 472, 473, 488, 502, 503, 515, 517, 525, 526, 528, 529, 530, 531, 532, 533, 534, 535, 599, 600, 601, 1009, 1010, 1011, 32642, 32643, 32644, 32645 } for nM,ZE2O in ipairs(Nw) do local aYX = reaper.JS_Mouse_LoadCursor( ZE2O ) if aYX then Nw[aYX] = true end Nw[nM] = nil end local Mtw = reaper.GetMouseModifier( "\77\77\95\67\84\88\95\73\84\69\77", 0, "" ) local kP = reaper.GetMouseModifier( "\77\77\95\67\84\88\95\73\84\69\77\76\79\87\69\82", 0, "" ) if reaper.BR_Win32_GetPrivateProfileString("\77\77\95\67\84\88\95\73\84\69\77\76\79\87\69\82", "\109\109\95\48", "", reaper.GetResourcePath() .. "\\\114\101\97\112\101\114\45\109\111\117\115\101\46\105\110\105") == 0 then kP = "\45\49" end reaper.SetMouseModifier( "\77\77\95\67\84\88\95\73\84\69\77", 0, "\48" ) reaper.SetMouseModifier( "\77\77\95\67\84\88\95\73\84\69\77\76\79\87\69\82", 0, "\48" ) local ir, ir, Aye, e2c = reaper.get_action_context()  reaper.SetToggleCommandState( Aye, e2c, 1 )  reaper.RefreshToolbar2( Aye, e2c ) local N655 if reaper.GetToggleCommandState( 42294 ) == 0 then local F6F = {42301, 42073, 42295} for ai8 = 1, 3 do if reaper.GetToggleCommandState( F6F[ai8] ) == 1 then N655 = F6F[ai8] break end end reaper.Main_OnCommand( 42294, 0 )  end local S0 = reaper.JS_Window_FindChildByID( reaper.GetMainHwnd(), 1000 ) local ir, dJN0, BmLr, aw, zp, wqF local Z_, LI3, Azb local log, floor, min, abs, max = math.log, math.floor, math.min, math.abs, math.max local r9 = math.exp(1) local lQj = false local gd = {} local Sa = {} local LFsX = false local function E6C( Hy ) return floor( (Hy - BmLr) * dJN0 + 0.5 ) end local function CQQL( KmQb ) return BmLr + KmQb / dJN0 end local function aF1( FtE ) local Qpv = reaper.JS_LICE_CreateBitmap( true, 1, 1 ) reaper.JS_LICE_Clear(Qpv, FtE or 0xFFFFFFFF) return Qpv end local Qpv = {} Qpv[1] = aF1( 0x3F000000 ) for ai8 = 2, 5 do Qpv[ai8] = aF1() end local function RW( ZiEd, SbW, CP, BWZn ) reaper.JS_Composite( S0, ZiEd, SbW, CP, BWZn, Qpv[1], 0, 0, 1, 1, true ) reaper.JS_Composite( S0, ZiEd, SbW, CP, 1, Qpv[2], 0, 0, 1, 1, true ) reaper.JS_Composite( S0, ZiEd, SbW+BWZn, CP, 1, Qpv[3], 0, 0, 1, 1, true ) reaper.JS_Composite( S0, ZiEd, SbW, 1, BWZn, Qpv[4], 0, 0, 1, 1, true ) reaper.JS_Composite( S0, ZiEd+CP, SbW, 1, BWZn, Qpv[5], 0, 0, 1, 1, true ) end local function ZZ5f() for ai8 = 1, 5 do reaper.JS_Composite_Unlink( S0, Qpv[ai8], true ) end end local h0JV = package.config:sub(1,1) local function KBc() if Z_ then reaper.JS_WindowMessage_Release( S0, "\87\77\95\76\66\85\84\84\79\78\68\79\87\78" ) end if LI3 then reaper.JS_WindowMessage_Release( S0, "\87\77\95\76\66\85\84\84\79\78\85\80" ) end end reaper.atexit(function() for ai8 = 1, 5 do reaper.JS_LICE_DestroyBitmap( Qpv[ai8] ) end reaper.SetMouseModifier( "\77\77\95\67\84\88\95\73\84\69\77", 0, Mtw ) reaper.SetMouseModifier( "\77\77\95\67\84\88\95\73\84\69\77\76\79\87\69\82", 0, kP ) KBc() reaper.SetToggleCommandState( Aye, e2c, 0 ) reaper.RefreshToolbar2( Aye, e2c ) if N655 then reaper.Main_OnCommand( N655, 0 ) end end) local function s6So() local ir, jzB = reaper.BR_Win32_GetPrivateProfileString("\114\101\97\112\101\114", "\115\112\101\99\103\114\97\109\95\112\114\101\115\101\116\48", "", dp ) tq = tonumber( jzB:match("\91\37\100\37\46\93\43\32\91\37\100\37\46\93\43\32\91\37\100\37\46\93\43\32\40\91\37\100\37\46\93\43\41") ) XNQ7 = .1 + tq * tq gd.dr8s = reaper.GetMediaItemTakeInfo_Value( gd.zkIs, "\68\95\83\84\65\82\84\79\70\70\83" ) end local function t8cc( eL ) local MGi = eL - gd.dAq if not LFsX then LFsX = MGi // gd.zs end if LFsX < 0 then LFsX = 0 end local IaNo = floor(LFsX * (gd.yJm-1) / gd.TN + 0.5) + gd.dAq - 1 local cq = floor((LFsX+1) * (gd.yJm-1) / gd.TN + 0.5) + gd.dAq local zs = cq - IaNo if eL <= IaNo then MGi = -1 elseif eL >= cq then MGi = zs else MGi = eL - IaNo end local zBF if tq ~= 0 then local czn = zs / log( 1 + XNQ7 ) zBF = (r9 ^( (zs - MGi - 1.5) /czn ) - 1 ) * gd.iP8S / XNQ7 else zBF = gd.iP8S * (zs - MGi - 1) / zs end if zBF < 0 then return 0 elseif zBF > gd.iP8S then return gd.iP8S else return zBF end end local GZ, uCR, wulu, oWQG, beuq, XIP, ba, lDx3, DlN = 1, 0, 0, 0, 0, 1, 1, 0, 0 local function ME() local jvFf = reaper.GetExtState( "\97\109\97\103\97\108\109\97\95\68\114\97\119\32\83\112\101\99\116\114\97\108\32\69\100\105\116\115\32\84\111\111\108", "\95" ) if jvFf ~= "" then local Nz, hquH = {}, 0 for alCE in jvFf:gmatch("\91\94\a\93\43") do hquH = hquH + 1 Nz[hquH] = tonumber( alCE ) end GZ, uCR, wulu, oWQG, beuq, XIP, ba, lDx3, DlN = table.unpack( Nz ) end end local function PFj() ME() local PO = string.format("\83\80\69\67\84\82\65\76\95\69\68\73\84\32\37\102\32\37\102\32\37\102\32\37\102\32\37\102\32\37\102\32\37\102\32\45\49\32\48\32\37\102\32\37\102\32\37\102\32\37\102\32\48\32\48\32\37\102\32\37\102", min(gd.IsI, gd.So), abs(gd.IsI - gd.So),  GZ, uCR, wulu, min(gd.bOq, gd.lT), max(gd.bOq, gd.lT), oWQG, beuq, XIP, ba, lDx3, DlN ) local f7k = ({reaper.GetItemStateChunk( gd.z8T, "", false )})[2] local Nz, hquH = {}, 0 local Du, pqhM = false, false for line in f7k:gmatch("\91\94\n\93\43") do if not Du and line == "\71\85\73\68\32" .. reaper.BR_GetMediaItemTakeGUID( gd.zkIs ) then Du = true end if not pqhM and Du then if line:match("\94\84\65\75\69") then hquH = hquH + 1 Nz[hquH] = PO pqhM = true end end hquH = hquH + 1 Nz[hquH] = line end if Du and not pqhM then Nz[hquH] = PO Nz[hquH+1] = "\62" end reaper.SetItemStateChunk( gd.z8T, table.concat(Nz, "\n"), false ) reaper.Undo_OnStateChange_Item( 0, "\65\100\100\32\115\112\101\99\116\114\97\108\32\101\100\105\116", gd.z8T ) end local zlAC, s4, K1A, mt, yMaK = 0, 0 local dtZv, oM, GYBR, s8_O local IX local function vc() local ZiEd, SbW = reaper.GetMousePosition() local KmQb, eL = reaper.JS_Window_ScreenToClient( S0, ZiEd, SbW ) dJN0 = reaper.GetHZoomLevel() BmLr, aw = reaper.GetSet_ArrangeView2( 0, 0, 0, 0 ) aw = aw - 18/dJN0  ir, zp, wqF = reaper.JS_Window_GetClientSize( S0 ) local SCZ_ = reaper.JS_Mouse_GetState( 255 ) & 1 == 1 local hzU0 = yMaK == false and SCZ_ yMaK = SCZ_ local z8T, zkIs = reaper.GetItemFromPoint( ZiEd, SbW, true ) ir, ir, mt = reaper.GetItemEditingTime2() if K1A ~= zkIs then K1A = zkIs s4 = true else s4 = false end if gd.zkIs or zkIs then if not lQj and s4 then gd.odW = reaper.GetMediaItemInfo_Value( gd.z8T or z8T, "\68\95\80\79\83\73\84\73\79\78" ) gd.LDb_ = gd.odW + reaper.GetMediaItemInfo_Value( gd.z8T or z8T, "\68\95\76\69\78\71\84\72" ) gd.vd9 = reaper.GetMediaItemTake_Source( gd.zkIs or zkIs ) gd.iP8S = reaper.GetMediaSourceSampleRate( gd.vd9 ) / 2 gd.TN = reaper.GetMediaItemTakeInfo_Value( gd.zkIs or zkIs, "\73\95\67\72\65\78\77\79\68\69" ) < 2 and reaper.GetMediaSourceNumChannels( gd.vd9 ) or 1 gd.qn2 = reaper.GetMediaItemTrack( gd.z8T or z8T ) end gd.jHk = reaper.GetMediaTrackInfo_Value( gd.qn2, "\73\95\84\67\80\89" ) gd.dAq = gd.jHk + reaper.GetMediaItemTakeInfo_Value( gd.zkIs or zkIs, "\73\95\76\65\83\84\89" ) gd.yJm = reaper.GetMediaItemTakeInfo_Value( gd.zkIs or zkIs, "\73\95\76\65\83\84\72" ) gd.zs = floor(gd.yJm / gd.TN + 0.5) if gd.odW < BmLr then Sa.tLFF = 0 else Sa.tLFF = E6C( gd.odW ) end if gd.LDb_ > aw then Sa.SQX = zp else Sa.SQX = E6C( gd.LDb_ ) end Sa.m5hX = gd.dAq if Sa.m5hX < 0 then Sa.m5hX = 0 end Sa.pu = gd.dAq + gd.yJm if Sa.pu >= wqF then  Sa.pu = wqF-1 end end if not gd.zkIs and not zkIs then if Sa.pu then Sa = {} end if gd.vd9 then gd = {} end end local VnEl = (Sa.tLFF and KmQb >= Sa.tLFF+7 and KmQb <= Sa.SQX-7 and eL >= Sa.m5hX and eL <= Sa.pu) and mt == 0 local ngVV = reaper.JS_Mouse_GetCursor() local Thz7 = Nw[ngVV] or false if lQj or (VnEl and Thz7 == false) then reaper.TrackCtl_SetToolTip( "\68\114\97\119\32\83\112\101\99\116\114\97\108\32\69\100\105\116", ZiEd-52, SbW-150, true ) IX = true if not Azb then Azb = true Z_ = reaper.JS_WindowMessage_Intercept( S0, "\87\77\95\76\66\85\84\84\79\78\68\79\87\78", false ) >= 0 LI3 = reaper.JS_WindowMessage_Intercept( S0, "\87\77\95\76\66\85\84\84\79\78\85\80", false ) >= 0 end else if IX then reaper.TrackCtl_SetToolTip( "", 0, 0, true ) IX = false end if Azb then Azb = false KBc() end end if not gd.zkIs then if hzU0 and VnEl and Thz7 == false then gd.zkIs, gd.z8T = zkIs, z8T s6So() gd.L4O = (eL - gd.dAq) / gd.yJm gd.bOq = t8cc( eL ) gd.IsI = CQQL( KmQb ) oM = gd.yJm dtZv = gd.jHk lQj = true end end if lQj then local MF4 = KmQb local I0 = eL if KmQb < Sa.tLFF then MF4 = Sa.tLFF end if KmQb > Sa.SQX then MF4 = Sa.SQX end GYBR = false if gd.jHk ~= dtZv then dtZv = gd.jHk GYBR = true end if gd.yJm ~= oM then oM = gd.yJm GYBR = true end local MGi = eL - gd.dAq gd.Rl = GYBR and s8_O or MGi // gd.zs if gd.Rl < 0 then gd.Rl = 0 end if GYBR or not Sa.asuZ then Sa.asuZ = floor(gd.Rl * (gd.yJm-1) / gd.TN + 0.5) + gd.dAq - 1 end if GYBR or not Sa.M8E4 then Sa.M8E4 = floor((gd.Rl+1) * (gd.yJm-1) / gd.TN + 0.5) + gd.dAq end if eL < Sa.asuZ then I0 = Sa.asuZ end if I0 < 0 then I0 = 0 end if eL > Sa.M8E4 then I0 = Sa.M8E4 end if I0 >= wqF then I0 = wqF-1 end local F18S = floor(gd.L4O * gd.yJm + gd.dAq + 0.5) local H1z = E6C( gd.IsI ) s8_O = gd.Rl local CP, BWZn = abs( MF4 - H1z ), abs( I0 - F18S ) if not SCZ_ then if CP*BWZn > 99 then gd.lT = t8cc( I0 ) gd.So = CQQL( MF4 ) gd.IsI = gd.IsI - gd.odW + gd.dr8s gd.So = gd.So - gd.odW + gd.dr8s PFj() end lQj = false gd.zkIs, gd.z8T = nil, nil Sa = {} LFsX = false ZZ5f() else RW( MF4 < H1z and MF4 or H1z, I0 < F18S and I0 or F18S, CP, BWZn ) end end reaper.defer(vc) end vc()
